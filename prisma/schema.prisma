generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id          String              @id @default(cuid())
  name        String
  slug        String              @unique
  domain      String?             @unique
  createdAt   DateTime            @default(now())
  updatedAt   DateTime            @updatedAt
  email       String?
  plan        String              @default("BASICO")
  status      String              @default("ACTIVO")
  subscriptionEndsAt DateTime?
  invitations Invitation[]
  payments    Payment[]
  commitments PaymentCommitment[]
  programs    Program[]
  prospects   Prospect[]
  receipts    Receipt[]
  roles       Role[]
  students    Student[]
  configs     SystemConfig[]
  branding    TenantBranding?
  users       User[]
  aiConversations AiConversation[]
  aiUsage     AiUsage[]

  // Embudo de ventas
  interactions     ProspectInteraction[]
  whatsappMessages WhatsAppMessage[]
  emailTemplates   EmailTemplate[]
  emailSequences   EmailSequence[]
  emailLogs        EmailLog[]
  masterclasses    Masterclass[]
  agentTasks       AgentTask[]
  agentMemories    AgentMemory[]

  @@index([slug])
  @@index([status])
}

model User {
  id                 String        @id @default(cuid())
  email              String        @unique
  password           String?
  name               String?
  image              String?
  emailVerified      DateTime?
  isActive           Boolean       @default(true)
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt
  roleId             String?
  invitationLimit    Int           @default(0)
  tenantId           String?
  platformRole       PlatformRole?
  sentInvitations    Invitation[]  @relation("SentInvitations")
  registeredPayments Payment[]
  profile            Profile?
  prospects          Prospect[]
  sessions           Session[]
  students           Student[]
  role               Role?         @relation(fields: [roleId], references: [id])
  tenant             Tenant?       @relation(fields: [tenantId], references: [id])
  mustChangePassword Boolean       @default(false)
  aiConversations    AiConversation[]
  advisorInteractions ProspectInteraction[] @relation("InteractionAdvisor")

  @@index([email])
  @@index([roleId])
  @@index([tenantId])
  @@index([platformRole])
}

model Role {
  id          String       @id @default(cuid())
  name        String
  description String?
  permissions String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  tenantId    String
  invitations Invitation[]
  tenant      Tenant       @relation(fields: [tenantId], references: [id])
  users       User[]

  @@unique([name, tenantId])
  @@index([name])
  @@index([tenantId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model PasswordReset {
  id        String   @id @default(cuid())
  email     String
  token     String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())

  @@index([email])
  @@index([token])
}

model Profile {
  id          String    @id @default(cuid())
  bio         String?
  phone       String?
  address     String?
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  userId    String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())
  tenantId  String?

  @@index([action])
  @@index([entity])
  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
}

model Program {
  id               String            @id @default(cuid())
  name             String
  description      String?
  totalValue       Decimal           @db.Decimal(10, 2)
  matriculaValue   Decimal           @default(60000) @db.Decimal(10, 2)
  modulesCount     Int               @default(6)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tenantId         String
  academicContents AcademicContent[]
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  prospects        Prospect[]
  students         Student[]

  @@unique([name, tenantId])
  @@index([name])
  @@index([isActive])
  @@index([tenantId])
}

model Student {
  id                  String              @id @default(cuid())
  fullName            String
  documentType        String              @default("CC")
  documentNumber      String
  email               String?
  phone               String
  address             String?
  guardianName        String?
  guardianPhone       String?
  guardianEmail       String?
  enrollmentDate      DateTime
  initialPayment      Decimal             @db.Decimal(10, 2)
  totalProgramValue   Decimal             @db.Decimal(10, 2)
  status              StudentStatus       @default(MATRICULADO)
  paymentFrequency    PaymentFrequency    @default(MENSUAL)
  firstCommitmentDate DateTime?
  currentModule       Int                 @default(0)
  matriculaPaid       Boolean             @default(false)
  programId           String
  advisorId           String
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  tenantId            String
  contentDeliveries   ContentDelivery[]
  payments            Payment[]
  commitments         PaymentCommitment[]
  advisor             User                @relation(fields: [advisorId], references: [id])
  program             Program             @relation(fields: [programId], references: [id])
  tenant              Tenant              @relation(fields: [tenantId], references: [id])

  @@unique([documentNumber, tenantId])
  @@index([documentNumber])
  @@index([status])
  @@index([programId])
  @@index([advisorId])
  @@index([enrollmentDate])
  @@index([matriculaPaid])
  @@index([currentModule])
  @@index([tenantId])
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  paymentDate    DateTime
  method         PaymentMethod
  reference      String?
  receiptNumber  String
  comments       String?
  paymentType    PaymentType   @default(MODULO)
  moduleNumber   Int?
  studentId      String
  registeredById String
  createdAt      DateTime      @default(now())
  tenantId       String
  registeredBy   User          @relation(fields: [registeredById], references: [id])
  student        Student       @relation(fields: [studentId], references: [id])
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  receipt        Receipt?

  @@unique([receiptNumber, tenantId])
  @@index([studentId])
  @@index([registeredById])
  @@index([paymentDate])
  @@index([receiptNumber])
  @@index([paymentType])
  @@index([tenantId])
}

model Receipt {
  id            String    @id @default(cuid())
  receiptNumber String
  generatedAt   DateTime  @default(now())
  sentVia       String?
  sentAt        DateTime?
  pdfUrl        String?
  paymentId     String    @unique
  tenantId      String
  payment       Payment   @relation(fields: [paymentId], references: [id])
  tenant        Tenant    @relation(fields: [tenantId], references: [id])

  @@unique([receiptNumber, tenantId])
  @@index([receiptNumber])
  @@index([tenantId])
}

model PaymentCommitment {
  id                String           @id @default(cuid())
  scheduledDate     DateTime
  amount            Decimal          @db.Decimal(10, 2)
  status            CommitmentStatus @default(PENDIENTE)
  rescheduledDate   DateTime?
  comments          String?
  moduleNumber      Int              @default(1)
  notificationsSent Json?
  studentId         String
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  tenantId          String?
  student           Student          @relation(fields: [studentId], references: [id])
  tenant            Tenant?          @relation(fields: [tenantId], references: [id])

  @@index([studentId])
  @@index([status])
  @@index([scheduledDate])
  @@index([moduleNumber])
  @@index([tenantId])
}

model Prospect {
  id              String           @id @default(cuid())
  name            String
  phone           String
  email           String?

  // Embudo de ventas
  funnelStage     FunnelStage      @default(NUEVO)
  temperature     LeadTemperature  @default(FRIO)
  source          LeadSource       @default(OTRO)
  sourceDetail    String?          // ej: "Landing Masterclass Feb", "Instagram Ad #123"
  score           Int              @default(0)     // Lead scoring 0-100

  // Campo legacy (mantener compatibilidad)
  status          ProspectStatus   @default(CONTACTADO)

  observations    String?
  programId       String?
  advisorId       String

  // Seguimiento
  lastContactAt   DateTime?
  nextFollowUpAt  DateTime?
  lostReason      String?          // Solo cuando funnelStage=PERDIDO

  // UTM Tracking (para Meta Ads)
  utmSource       String?
  utmMedium       String?
  utmCampaign     String?
  utmContent      String?

  // Datos adicionales
  city            String?
  occupation      String?          // "Estudiante universitario", "Profesional", etc.

  // Masterclass
  masterclassId         String?
  masterclassRegisteredAt DateTime?
  masterclassAttendedAt   DateTime?

  createdAt       DateTime         @default(now())
  updatedAt       DateTime         @updatedAt
  tenantId        String

  advisor         User             @relation(fields: [advisorId], references: [id])
  program         Program?         @relation(fields: [programId], references: [id])
  tenant          Tenant           @relation(fields: [tenantId], references: [id])

  // Nuevas relaciones
  interactions     ProspectInteraction[]
  whatsappMessages WhatsAppMessage[]
  emailLogs        EmailLog[]
  agentTasks       AgentTask[]

  @@index([funnelStage])
  @@index([temperature])
  @@index([source])
  @@index([score])
  @@index([status])
  @@index([advisorId])
  @@index([programId])
  @@index([tenantId])
  @@index([lastContactAt])
  @@index([nextFollowUpAt])
}

// ============================================
// MODELO: Interacciones con Prospectos (Timeline)
// ============================================
model ProspectInteraction {
  id          String          @id @default(cuid())
  type        InteractionType
  content     String          @db.Text
  metadata    Json?           // Datos flexibles (duracion llamada, template usado, etc.)
  prospectId  String
  advisorId   String?         // null para interacciones del sistema/agente
  agentType   AgentType?      // Cual agente IA creo esto
  createdAt   DateTime        @default(now())
  tenantId    String

  prospect    Prospect        @relation(fields: [prospectId], references: [id], onDelete: Cascade)
  advisor     User?           @relation("InteractionAdvisor", fields: [advisorId], references: [id])
  tenant      Tenant          @relation(fields: [tenantId], references: [id])

  @@index([prospectId])
  @@index([type])
  @@index([advisorId])
  @@index([tenantId])
  @@index([createdAt])
}

// ============================================
// MODELO: Mensajes de WhatsApp
// ============================================
model WhatsAppMessage {
  id            String          @id @default(cuid())
  waMessageId   String?         @unique   // ID de Meta para tracking
  direction     MessageDirection
  phone         String
  content       String          @db.Text
  templateName  String?         // null para mensajes de texto libre
  status        WaMessageStatus @default(PENDING)
  metadata      Json?           // Respuesta completa de API, errores
  prospectId    String?
  tenantId      String
  sentAt        DateTime        @default(now())
  deliveredAt   DateTime?
  readAt        DateTime?

  prospect      Prospect?       @relation(fields: [prospectId], references: [id])
  tenant        Tenant          @relation(fields: [tenantId], references: [id])

  @@index([waMessageId])
  @@index([phone])
  @@index([prospectId])
  @@index([tenantId])
  @@index([direction])
  @@index([status])
  @@index([sentAt])
}

// ============================================
// MODELO: Plantillas de Email
// ============================================
model EmailTemplate {
  id          String   @id @default(cuid())
  name        String               // "bienvenida", "recordatorio_masterclass", etc.
  subject     String
  htmlContent String   @db.Text    // HTML con {{variable}} placeholders
  variables   String[]             // ["nombre", "fecha_masterclass", "enlace"]
  isActive    Boolean  @default(true)
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id])
  emailLogs   EmailLog[]

  @@unique([name, tenantId])
  @@index([name])
  @@index([tenantId])
  @@index([isActive])
}

// ============================================
// MODELO: Secuencias de Email Automatizadas
// ============================================
model EmailSequence {
  id            String              @id @default(cuid())
  name          String              // "Secuencia Post-Registro"
  triggerStage  FunnelStage         // Que etapa dispara esta secuencia
  isActive      Boolean             @default(true)
  tenantId      String
  createdAt     DateTime            @default(now())
  updatedAt     DateTime            @updatedAt

  tenant        Tenant              @relation(fields: [tenantId], references: [id])
  steps         EmailSequenceStep[]

  @@unique([name, tenantId])
  @@index([triggerStage])
  @@index([tenantId])
}

model EmailSequenceStep {
  id            String        @id @default(cuid())
  sequenceId    String
  templateId    String        // Referencia al EmailTemplate a usar
  orderIndex    Int           // 0, 1, 2... orden de envio
  delayHours    Int           // Horas de espera despues del paso anterior (o del trigger)
  createdAt     DateTime      @default(now())

  sequence      EmailSequence @relation(fields: [sequenceId], references: [id], onDelete: Cascade)

  @@index([sequenceId])
  @@index([orderIndex])
}

// ============================================
// MODELO: Log de Emails Enviados
// ============================================
model EmailLog {
  id          String         @id @default(cuid())
  to          String
  subject     String
  templateId  String?
  prospectId  String?
  status      String         @default("SENT") // SENT, DELIVERED, OPENED, CLICKED, BOUNCED, FAILED
  resendId    String?        // ID de Resend para tracking
  metadata    Json?
  tenantId    String
  sentAt      DateTime       @default(now())

  template    EmailTemplate? @relation(fields: [templateId], references: [id])
  prospect    Prospect?      @relation(fields: [prospectId], references: [id])
  tenant      Tenant         @relation(fields: [tenantId], references: [id])

  @@index([prospectId])
  @@index([templateId])
  @@index([tenantId])
  @@index([status])
  @@index([sentAt])
}

// ============================================
// MODELO: Masterclasses
// ============================================
model Masterclass {
  id          String   @id @default(cuid())
  title       String
  description String?  @db.Text
  scheduledAt DateTime
  duration    Int      @default(60)  // minutos
  meetingUrl  String?  // Zoom/Google Meet link
  isActive    Boolean  @default(true)
  slug        String   // URL-friendly para landing page
  tenantId    String
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  tenant      Tenant   @relation(fields: [tenantId], references: [id])

  @@unique([slug, tenantId])
  @@index([scheduledAt])
  @@index([tenantId])
  @@index([isActive])
}

// ============================================
// MODELO: Tareas de Agentes IA (Kanban)
// ============================================
model AgentTask {
  id            String          @id @default(cuid())
  title         String
  description   String          @db.Text
  status        AgentTaskStatus @default(PENDIENTE)
  agentType     AgentType       // MARGY o KALED
  priority      Int             @default(0)  // 0=normal, 1=alta, 2=urgente
  result        String?         @db.Text     // Resultado de la tarea
  prospectId    String?
  metadata      Json?           // Datos flexibles: que funciono, que no
  completedAt   DateTime?
  tenantId      String
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  prospect      Prospect?       @relation(fields: [prospectId], references: [id])
  tenant        Tenant          @relation(fields: [tenantId], references: [id])

  @@index([status])
  @@index([agentType])
  @@index([prospectId])
  @@index([tenantId])
  @@index([priority])
  @@index([createdAt])
}

// ============================================
// MODELO: Memoria de Agentes (Auto-mejora)
// ============================================
model AgentMemory {
  id          String    @id @default(cuid())
  agentType   AgentType
  category    String    // "estrategia", "manejo_objeciones", "patron_conversion"
  content     String    @db.Text
  score       Int       @default(0) // Puntuacion de efectividad
  metadata    Json?
  tenantId    String
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  tenant      Tenant    @relation(fields: [tenantId], references: [id])

  @@index([agentType])
  @@index([category])
  @@index([tenantId])
  @@index([score])
}

model AcademicContent {
  id          String            @id @default(cuid())
  name        String
  description String?
  orderIndex  Int
  programId   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  program     Program           @relation(fields: [programId], references: [id])
  deliveries  ContentDelivery[]

  @@index([programId])
  @@index([orderIndex])
}

model ContentDelivery {
  id          String          @id @default(cuid())
  deliveredAt DateTime        @default(now())
  method      String
  studentId   String
  contentId   String
  content     AcademicContent @relation(fields: [contentId], references: [id])
  student     Student         @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([contentId])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String
  value     String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenantId  String?
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([key, tenantId])
  @@index([key])
  @@index([tenantId])
}

model Invitation {
  id        String           @id @default(cuid())
  email     String
  roleId    String
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  expiresAt DateTime
  inviterId String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenantId  String
  inviter   User             @relation("SentInvitations", fields: [inviterId], references: [id])
  role      Role             @relation(fields: [roleId], references: [id])
  tenant    Tenant           @relation(fields: [tenantId], references: [id])

  @@index([email])
  @@index([token])
  @@index([inviterId])
}

model TenantBranding {
  id              String   @id @default(cuid())
  tenantId        String   @unique
  logoUrl         String?
  faviconUrl      String?
  primaryColor    String   @default("#1e3a5f")
  secondaryColor  String   @default("#3b82f6")
  accentColor     String   @default("#10b981")
  fontFamily      String   @default("Inter")
  loginBgImage    String?
  loginBgGradient String?
  footerText      String?
  customCss       String?
  darkMode        Boolean  @default(false)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt
  tenant          Tenant   @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@index([tenantId])
}

enum PlatformRole {
  SUPER_ADMIN
  ASESOR_COMERCIAL
  MARKETING
}

enum StudentStatus {
  MATRICULADO
  ACTIVO
  INACTIVO
  GRADUADO
  EN_OTRA_INSTITUCION
  PENDIENTE
}

enum PaymentFrequency {
  MENSUAL
  QUINCENAL
}

enum PaymentType {
  MATRICULA
  MODULO
}

enum PaymentMethod {
  BANCOLOMBIA
  NEQUI
  DAVIPLATA
  EFECTIVO
  OTRO
}

enum CommitmentStatus {
  PAGADO
  PENDIENTE
  EN_COMPROMISO
}

enum ProspectStatus {
  CONTACTADO
  EN_SEGUIMIENTO
  CERRADO
  PERDIDO
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}

// ============================================
// ENUMS EMBUDO DE VENTAS
// ============================================

enum FunnelStage {
  NUEVO
  CONTACTADO
  INTERESADO
  MASTERCLASS_REGISTRADO
  MASTERCLASS_ASISTIO
  APLICACION
  LLAMADA_AGENDADA
  LLAMADA_REALIZADA
  NEGOCIACION
  MATRICULADO
  PERDIDO
}

enum LeadTemperature {
  FRIO
  TIBIO
  CALIENTE
}

enum LeadSource {
  LANDING_PAGE
  WHATSAPP
  REFERIDO
  REDES_SOCIALES
  LLAMADA
  EMAIL
  OTRO
}

enum InteractionType {
  LLAMADA
  WHATSAPP_ENVIADO
  WHATSAPP_RECIBIDO
  EMAIL_ENVIADO
  EMAIL_RECIBIDO
  NOTA
  CAMBIO_ETAPA
  REUNION
  MASTERCLASS
  SISTEMA
}

enum MessageDirection {
  INBOUND
  OUTBOUND
}

enum WaMessageStatus {
  PENDING
  SENT
  DELIVERED
  READ
  FAILED
}

enum AgentTaskStatus {
  PENDIENTE
  EN_PROCESO
  COMPLETADA
  MEJORA
}

enum AgentType {
  MARGY
  KALED
}

model AiConversation {
  id                      String   @id @default(cuid())
  title                   String?
  userId                  String
  tenantId                String
  summary                 String?  @db.Text
  summaryUpToMessageIndex Int?
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  user     User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  tenant   Tenant      @relation(fields: [tenantId], references: [id], onDelete: Cascade)
  messages AiMessage[]

  @@index([userId])
  @@index([tenantId])
  @@index([createdAt])
}

model AiMessage {
  id             String   @id @default(cuid())
  conversationId String
  role           String
  content        String   @db.Text
  toolCalls      Json?
  toolResults    Json?
  createdAt      DateTime @default(now())

  // Token tracking fields
  modelUsed      String?
  inputTokens    Int?
  outputTokens   Int?
  totalTokens    Int?
  costInCents    Int?
  cached         Boolean  @default(false)

  conversation AiConversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)

  @@index([conversationId])
  @@index([createdAt])
  @@index([modelUsed])
}

model AiModel {
  id                String      @id @default(cuid())
  name              String
  provider          String
  modelIdentifier   String      @unique
  freeTokensLimit   Int         @default(100000)
  inputCostPer1k    Decimal     @default(0.0) @db.Decimal(10, 6)
  outputCostPer1k   Decimal     @default(0.0) @db.Decimal(10, 6)
  isActive          Boolean     @default(true)
  resetPeriod       ResetPeriod @default(MONTHLY)
  createdAt         DateTime    @default(now())
  updatedAt         DateTime    @updatedAt

  usage AiUsage[]

  @@index([provider])
  @@index([isActive])
}

model AiUsage {
  id              String   @id @default(cuid())
  tenantId        String?
  modelId         String
  period          DateTime
  totalTokens     Int      @default(0)
  inputTokens     Int      @default(0)
  outputTokens    Int      @default(0)
  totalCostCents  Int      @default(0)
  messagesCount   Int      @default(0)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  model  AiModel  @relation(fields: [modelId], references: [id], onDelete: Cascade)
  tenant Tenant?  @relation(fields: [tenantId], references: [id], onDelete: Cascade)

  @@unique([tenantId, modelId, period])
  @@index([tenantId])
  @@index([modelId])
  @@index([period])
}

model AiResponseCache {
  id              String   @id @default(cuid())
  queryHash       String
  queryNormalized String   @db.Text
  response        String   @db.Text
  toolsUsed       Json?
  hitCount        Int      @default(0)
  lastHitAt       DateTime @default(now())
  expiresAt       DateTime
  tenantId        String
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@unique([tenantId, queryHash])
  @@index([tenantId])
  @@index([expiresAt])
}

model AiDocument {
  id        String   @id @default(cuid())
  tenantId  String
  title     String
  content   String   @db.Text
  category  String   @default("faq")
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  chunks AiDocumentChunk[]

  @@index([tenantId])
  @@index([category])
  @@index([isActive])
}

model AiDocumentChunk {
  id         String   @id @default(cuid())
  documentId String
  tenantId   String
  chunkIndex Int
  content    String   @db.Text
  tokenCount Int      @default(0)
  createdAt  DateTime @default(now())

  document AiDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)

  @@index([documentId])
  @@index([tenantId])
}

enum ResetPeriod {
  DAILY
  MONTHLY
  YEARLY
}
