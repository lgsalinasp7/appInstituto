generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Tenant {
  id        String   @id @default(cuid())
  name      String
  slug      String   @unique // The subdomain (e.g., 'edutec')
  domain    String?  @unique // Optional custom domain
  status    String   @default("ACTIVO") // ACTIVO, PENDIENTE, SUSPENDIDO, CANCELADO
  plan      String   @default("BASICO") // BASICO, PROFESIONAL, EMPRESARIAL
  email     String?  // Contact email for the tenant
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  users     User[]
  students  Student[]
  programs  Program[]
  payments  Payment[]
  prospects Prospect[]
  roles     Role[]
  invitations Invitation[]
  commitments PaymentCommitment[]
  configs     SystemConfig[]

  @@index([slug])
  @@index([status])
}


model User {
  id                 String       @id @default(cuid())
  email              String       @unique
  password           String?
  name               String?
  image              String?
  emailVerified      DateTime?
  isActive           Boolean      @default(true)
  createdAt          DateTime     @default(now())
  updatedAt          DateTime     @updatedAt
  roleId             String
  tenantId           String
  invitationLimit    Int          @default(0)
  sentInvitations    Invitation[] @relation("SentInvitations")
  registeredPayments Payment[]
  profile            Profile?
  prospects          Prospect[]
  sessions           Session[]
  students           Student[]
  role               Role         @relation(fields: [roleId], references: [id])
  tenant             Tenant       @relation(fields: [tenantId], references: [id])


  @@index([email])
  @@index([roleId])
}

model Role {
  id          String       @id @default(cuid())
  name        String       @unique
  description String?
  permissions String[]
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  invitations Invitation[]
  users       User[]
  tenantId    String
  tenant      Tenant       @relation(fields: [tenantId], references: [id])


  @@index([name])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  createdAt    DateTime @default(now())
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model Profile {
  id          String    @id @default(cuid())
  bio         String?
  phone       String?
  address     String?
  dateOfBirth DateTime?
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt
  userId      String    @unique
  user        User      @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model AuditLog {
  id        String   @id @default(cuid())
  action    String
  entity    String
  entityId  String?
  userId    String?
  metadata  Json?
  ipAddress String?
  userAgent String?
  createdAt DateTime @default(now())

  @@index([action])
  @@index([entity])
  @@index([userId])
  @@index([createdAt])
}

model Program {
  id               String            @id @default(cuid())
  name             String            @unique
  description      String?
  totalValue       Decimal           @db.Decimal(10, 2)
  matriculaValue   Decimal           @default(60000) @db.Decimal(10, 2)
  modulesCount     Int               @default(6)
  isActive         Boolean           @default(true)
  createdAt        DateTime          @default(now())
  updatedAt        DateTime          @updatedAt
  tenantId         String
  tenant           Tenant            @relation(fields: [tenantId], references: [id])
  academicContents AcademicContent[]

  prospects        Prospect[]
  students         Student[]

  @@index([name])
  @@index([isActive])
}

model Student {
  id                  String              @id @default(cuid())
  fullName            String
  documentType        String              @default("CC")
  documentNumber      String              @unique
  email               String?
  phone               String
  address             String?
  guardianName        String?
  guardianPhone       String?
  guardianEmail       String?
  enrollmentDate      DateTime
  initialPayment      Decimal             @db.Decimal(10, 2)
  totalProgramValue   Decimal             @db.Decimal(10, 2)
  status              StudentStatus       @default(MATRICULADO)
  paymentFrequency    PaymentFrequency    @default(MENSUAL)
  firstCommitmentDate DateTime?
  currentModule       Int                 @default(0)
  matriculaPaid       Boolean             @default(false)
  programId           String
  advisorId           String
  tenantId            String
  tenant              Tenant              @relation(fields: [tenantId], references: [id])
  createdAt           DateTime            @default(now())
  updatedAt           DateTime            @updatedAt
  contentDeliveries   ContentDelivery[]
  payments            Payment[]
  commitments         PaymentCommitment[]
  advisor             User                @relation(fields: [advisorId], references: [id])
  program             Program             @relation(fields: [programId], references: [id])

  @@index([documentNumber])
  @@index([status])
  @@index([programId])
  @@index([advisorId])
  @@index([enrollmentDate])
  @@index([matriculaPaid])
  @@index([currentModule])
}

model Payment {
  id             String        @id @default(cuid())
  amount         Decimal       @db.Decimal(10, 2)
  paymentDate    DateTime
  method         PaymentMethod
  reference      String?
  receiptNumber  String        @unique
  comments       String?
  paymentType    PaymentType   @default(MODULO)
  moduleNumber   Int?
  studentId      String
  registeredById String
  tenantId       String
  createdAt      DateTime      @default(now())
  tenant         Tenant        @relation(fields: [tenantId], references: [id])
  registeredBy   User          @relation(fields: [registeredById], references: [id])
  student        Student       @relation(fields: [studentId], references: [id])
  receipt        Receipt?

  @@index([studentId])
  @@index([registeredById])
  @@index([paymentDate])
  @@index([receiptNumber])
  @@index([paymentType])
}

model Receipt {
  id            String    @id @default(cuid())
  receiptNumber String    @unique
  generatedAt   DateTime  @default(now())
  sentVia       String?
  sentAt        DateTime?
  pdfUrl        String?
  paymentId     String    @unique
  payment       Payment   @relation(fields: [paymentId], references: [id])

  @@index([receiptNumber])
}

model PaymentCommitment {
  id                String           @id @default(cuid())
  scheduledDate     DateTime
  amount            Decimal          @db.Decimal(10, 2)
  status            CommitmentStatus @default(PENDIENTE)
  rescheduledDate   DateTime?
  comments          String?
  moduleNumber      Int              @default(1)
  notificationsSent Json?
  studentId         String
  tenantId          String?
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt
  student           Student          @relation(fields: [studentId], references: [id])
  tenant            Tenant?          @relation(fields: [tenantId], references: [id])

  @@index([studentId])
  @@index([status])
  @@index([scheduledDate])
  @@index([moduleNumber])
  @@index([tenantId])
}

model Prospect {
  id           String         @id @default(cuid())
  name         String
  phone        String
  email        String?
  status       ProspectStatus @default(CONTACTADO)
  observations String?
  programId    String?
  advisorId    String
  tenantId     String
  createdAt    DateTime       @default(now())
  tenant       Tenant         @relation(fields: [tenantId], references: [id])
  updatedAt    DateTime       @updatedAt
  advisor      User           @relation(fields: [advisorId], references: [id])
  program      Program?       @relation(fields: [programId], references: [id])

  @@index([status])
  @@index([advisorId])
  @@index([programId])
}

model AcademicContent {
  id          String            @id @default(cuid())
  name        String
  description String?
  orderIndex  Int
  programId   String
  createdAt   DateTime          @default(now())
  updatedAt   DateTime          @updatedAt
  program     Program           @relation(fields: [programId], references: [id])
  deliveries  ContentDelivery[]

  @@index([programId])
  @@index([orderIndex])
}

model ContentDelivery {
  id          String          @id @default(cuid())
  deliveredAt DateTime        @default(now())
  method      String
  studentId   String
  contentId   String
  content     AcademicContent @relation(fields: [contentId], references: [id])
  student     Student         @relation(fields: [studentId], references: [id])

  @@index([studentId])
  @@index([contentId])
}

model SystemConfig {
  id        String   @id @default(cuid())
  key       String
  value     String
  tenantId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  tenant    Tenant?  @relation(fields: [tenantId], references: [id])

  @@unique([key, tenantId])
  @@index([key])
  @@index([tenantId])
}

model Invitation {
  id        String           @id @default(cuid())
  email     String
  roleId    String
  status    InvitationStatus @default(PENDING)
  token     String           @unique
  expiresAt DateTime
  inviterId String
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt
  tenantId  String
  tenant    Tenant           @relation(fields: [tenantId], references: [id])
  inviter   User             @relation("SentInvitations", fields: [inviterId], references: [id])
  role      Role             @relation(fields: [roleId], references: [id])

  @@index([email])
  @@index([token])
  @@index([inviterId])
}

enum StudentStatus {
  MATRICULADO
  ACTIVO
  INACTIVO
  GRADUADO
  EN_OTRA_INSTITUCION
  PENDIENTE
}

enum PaymentFrequency {
  MENSUAL
  QUINCENAL
}

enum PaymentType {
  MATRICULA
  MODULO
}

enum PaymentMethod {
  BANCOLOMBIA
  NEQUI
  DAVIPLATA
  EFECTIVO
  OTRO
}

enum CommitmentStatus {
  PAGADO
  PENDIENTE
  EN_COMPROMISO
}

enum ProspectStatus {
  CONTACTADO
  EN_SEGUIMIENTO
  CERRADO
  PERDIDO
}

enum InvitationStatus {
  PENDING
  ACCEPTED
  EXPIRED
}
